name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: 18

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for better analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Check Commit Messages
        run: |
          # Validate commit messages follow conventional commits
          npm install -g @commitlint/cli @commitlint/config-conventional
          echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
          
          # Check all commits in the PR
          git log --format=%s origin/${{ github.base_ref }}..HEAD | while read commit; do
            echo "$commit" | commitlint
          done
          
      - name: Install Dependencies
        run: |
          npm install
          cd backend && npm ci
          cd ../frontend && npm ci
          
      - name: Type Check
        run: |
          cd backend && npx tsc --noEmit
          cd ../frontend && npx tsc --noEmit
          
      - name: Lint
        run: |
          cd backend && npm run lint
          cd ../frontend && npm run lint
          
      - name: Test
        run: |
          cd backend && npm run test:unit
          cd ../frontend && npm test -- --watchAll=false
          
      - name: Build
        run: |
          cd backend && npm run build
          cd ../frontend && npm run build
          
      - name: Security Audit
        run: |
          cd backend && npm audit --audit-level=high
          cd ../frontend && npm audit --audit-level=high
          
      - name: Bundle Size Check
        run: |
          cd frontend
          npm run build
          echo "Bundle sizes:"
          find build/static -name "*.js" -o -name "*.css" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            echo "$(basename $file): $(numfmt --to=iec-i --suffix=B $size)"
          done
          
      - name: Comment PR
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### ğŸ” PR Validation Results
            
            âœ… **Type Check**: Passed
            âœ… **Linting**: Passed
            âœ… **Tests**: Passed
            âœ… **Build**: Successful
            âœ… **Security**: No high vulnerabilities
            
            *Commit SHA: ${{ github.event.pull_request.head.sha }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
